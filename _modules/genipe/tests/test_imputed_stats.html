

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>genipe.tests.test_imputed_stats &#8212; genipe 1.5.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">genipe 1.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../genipe.html" accesskey="U">genipe</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">genipe.tests.test_imputed_stats</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for genipe.tests.test_imputed_stats</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># This file is part of genipe.</span>
<span class="c1">#</span>
<span class="c1"># This work is licensed under the Creative Commons Attribution-NonCommercial</span>
<span class="c1"># 4.0 International License. To view a copy of this license, visit</span>
<span class="c1"># http://creativecommons.org/licenses/by-nc/4.0/ or send a letter to Creative</span>
<span class="c1"># Commons, PO Box 1866, Mountain View, CA 94042, USA.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span> <span class="k">as</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>

<span class="kn">from</span> <span class="nn">..tools</span> <span class="kn">import</span> <span class="n">imputed_stats</span>

<span class="k">if</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_STATSMODELS</span><span class="p">:</span>
    <span class="c1"># patsy is installed only if statsmodels is</span>
    <span class="kn">import</span> <span class="nn">patsy</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Louis-Philippe Lemieux Perreault&quot;</span><span class="p">,</span> <span class="s2">&quot;Marc-Andre Legault&quot;</span><span class="p">]</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2014, Beaulieu-Saucier Pharmacogenomics Centre&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TestImputedStats&quot;</span><span class="p">,</span> <span class="s2">&quot;TestImputedStatsCox&quot;</span><span class="p">,</span> <span class="s2">&quot;TestImputedStatsLinear&quot;</span><span class="p">,</span>
           <span class="s2">&quot;TestImputedStatsLogistic&quot;</span><span class="p">,</span> <span class="s2">&quot;TestImputedStatsMixedLM&quot;</span><span class="p">,</span>
           <span class="s2">&quot;TestImputedStatsSkat&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">clean_logging_handlers</span><span class="p">():</span>
    <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds values for d1, d2 and d3 from dosage.&quot;&quot;&quot;</span>
    <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dosage</span><span class="p">):</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">d2</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">((</span><span class="n">dosage</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">d3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="p">(</span><span class="n">dosage</span> <span class="o">-</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span>


<span class="k">def</span> <span class="nf">create_input_files</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="n">output_dirname</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span>
                       <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">tte</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
                       <span class="n">interaction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_process</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates input files for the imputed_stats script.&quot;&quot;&quot;</span>
    <span class="c1"># Reading the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span>

    <span class="c1"># Adding a sample column</span>
    <span class="k">if</span> <span class="n">sample_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>
        <span class="n">sample_col</span> <span class="o">=</span> <span class="s2">&quot;sample_id&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">sample_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>

    <span class="c1"># Saving the phenotypes to file</span>
    <span class="n">pheno_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s2">&quot;phenotypes.txt&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pheno_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s2">&quot;999999&quot;</span><span class="p">)</span>

    <span class="c1"># Creating the sample file (watch out for duplicated data)</span>
    <span class="n">seen_samples</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sample_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s2">&quot;samples.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ID_1 ID_2 missing father mother sex plink_pheno&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;0 0 0 D D D B&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">gender</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[[</span><span class="n">sample_col</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">seen_samples</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">gender</span> <span class="o">==</span> <span class="n">seen_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="s2">&quot;-9&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
            <span class="n">seen_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender</span>

    <span class="c1"># Creating the IMPUTE2 file (watch out for duplicated data)</span>
    <span class="n">impute2_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s2">&quot;impute2.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impute2_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="n">seen_samples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;22 marker_1 1 T C&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[[</span><span class="n">sample_col</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">seen_samples</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
            <span class="n">seen_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

        <span class="n">seen_samples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;22 marker_2 2 G A&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[[</span><span class="n">sample_col</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">seen_samples</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
            <span class="n">seen_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

        <span class="n">seen_samples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;22 marker_3 3 AT A&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[[</span><span class="n">sample_col</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">seen_samples</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
            <span class="n">seen_samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

    <span class="c1"># The prefix of the output files</span>
    <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s2">&quot;test_imputed_stats&quot;</span><span class="p">)</span>

    <span class="c1"># The tool&#39;s options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">analysis_type</span><span class="p">,</span>
        <span class="s2">&quot;--impute2&quot;</span><span class="p">,</span> <span class="n">impute2_filename</span><span class="p">,</span>
        <span class="s2">&quot;--sample&quot;</span><span class="p">,</span> <span class="n">sample_filename</span><span class="p">,</span>
        <span class="s2">&quot;--pheno&quot;</span><span class="p">,</span> <span class="n">pheno_filename</span><span class="p">,</span>
        <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="s2">&quot;--gender-column&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--missing-value&quot;</span><span class="p">,</span> <span class="s2">&quot;999999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--sample-column&quot;</span><span class="p">,</span> <span class="n">sample_col</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Is this Cox or linear?</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;cox&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--time-to-event&quot;</span><span class="p">,</span> <span class="n">tte</span><span class="p">,</span> <span class="s2">&quot;--event&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="n">pheno_name</span><span class="p">])</span>

    <span class="c1"># Is this mixedlm?</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;mixedlm&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_ml</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--use-ml&quot;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--covar&quot;</span><span class="p">,</span> <span class="s2">&quot;C1,C2,C3,age,gender,visit&quot;</span><span class="p">])</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--categorical&quot;</span><span class="p">,</span> <span class="s2">&quot;visit&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--covar&quot;</span><span class="p">,</span> <span class="s2">&quot;C1,C2,C3,age,gender&quot;</span><span class="p">])</span>

    <span class="c1"># Is there interaction?</span>
    <span class="k">if</span> <span class="n">interaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--interaction&quot;</span><span class="p">,</span> <span class="n">interaction</span><span class="p">])</span>

    <span class="c1"># Multi processes are required?</span>
    <span class="k">if</span> <span class="n">nb_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_process</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span>


<div class="viewcode-block" id="TestImputedStats"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats">[docs]</a><span class="k">class</span> <span class="nc">TestImputedStats</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestImputedStats.setUp"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.tearDown"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c1"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStats.test_read_phenotype"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_read_phenotype">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_phenotype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;read_phenotype&#39; function.&quot;&quot;&quot;</span>
        <span class="c1"># A dummy object for options</span>
        <span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c1"># The content of the phenotype file</span>
        <span class="n">phenotype_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;sample_id</span><span class="se">\t</span><span class="s2">Time_To_Event</span><span class="se">\t</span><span class="s2">Event</span><span class="se">\t</span><span class="s2">C1</span><span class="se">\t</span><span class="s2">C2</span><span class="se">\t</span><span class="s2">C3</span><span class="se">\t</span><span class="s2">C4</span><span class="se">\t</span><span class="s2">Gender</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Pheno_Lin</span><span class="se">\t</span><span class="s2">Pheno_Logit</span><span class="se">\t</span><span class="s2">Inter</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;sample_1</span><span class="se">\t</span><span class="s2">10</span><span class="se">\t</span><span class="s2">0</span><span class="se">\t</span><span class="s2">0.3</span><span class="se">\t</span><span class="s2">0.2</span><span class="se">\t</span><span class="s2">0.45</span><span class="se">\t</span><span class="s2">0.01</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.01</span><span class="se">\t</span><span class="s2">0</span><span class="se">\t</span><span class="s2">0.00001</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;sample_2</span><span class="se">\t</span><span class="s2">2</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.9</span><span class="se">\t</span><span class="s2">0.1</span><span class="se">\t</span><span class="s2">0.42</span><span class="se">\t</span><span class="s2">0.012</span><span class="se">\t</span><span class="s2">2</span><span class="se">\t</span><span class="s2">0.15</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.00332</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;sample_3</span><span class="se">\t</span><span class="s2">8</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.4</span><span class="se">\t</span><span class="s2">0.67</span><span class="se">\t</span><span class="s2">999</span><span class="se">\t</span><span class="s2">0.001</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.0</span><span class="se">\t</span><span class="s2">0</span><span class="se">\t</span><span class="s2">0.000001</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;phenotypes.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">phenotype_content</span><span class="p">)</span>

        <span class="c1"># Need an object for the function&#39;s option</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">sample_column</span> <span class="o">=</span> <span class="s2">&quot;sample_id&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s2">&quot;cox&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">tte</span> <span class="o">=</span> <span class="s2">&quot;Time_To_Event&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;Event&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">args</span><span class="o">.</span><span class="n">gender_column</span> <span class="o">=</span> <span class="s2">&quot;Gender&quot;</span>

        <span class="c1"># The expected value</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Time_To_Event&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Event&quot;</span><span class="p">}</span>
        <span class="n">expected_index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_3&quot;</span><span class="p">]</span>
        <span class="n">expected_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="mi">999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_gender</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_tte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_tte</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Time_To_Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_event</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Modifying the missing value to 999</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="s2">&quot;999&quot;</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_gender</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_tte</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Time_To_Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_event</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Changing from Cox to linear should remove a column</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>
        <span class="k">del</span> <span class="n">args</span><span class="o">.</span><span class="n">tte</span>
        <span class="k">del</span> <span class="n">args</span><span class="o">.</span><span class="n">event</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pheno_name</span> <span class="o">=</span> <span class="s2">&quot;Pheno_Lin&quot;</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Pheno_Lin&quot;</span><span class="p">}</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Lin</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Changing from linear to logistic shouldn&#39;t change a thing</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s2">&quot;logistic&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pheno_name</span> <span class="o">=</span> <span class="s2">&quot;Pheno_Logit&quot;</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Pheno_Logit&quot;</span><span class="p">}</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Adding an interaction</span>
        <span class="n">args</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="s2">&quot;Inter&quot;</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Pheno_Logit&quot;</span><span class="p">,</span> <span class="s2">&quot;Inter&quot;</span><span class="p">}</span>
        <span class="n">expected_inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00332</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Removing the gender in the covars, but setting chrx to true</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Adding a sample (with unknown gender) (should be included since not</span>
        <span class="c1"># in covar, even though we ask for chrX)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;sample_4</span><span class="se">\t</span><span class="s2">8</span><span class="se">\t</span><span class="s2">1</span><span class="se">\t</span><span class="s2">0.4</span><span class="se">\t</span><span class="s2">0.67</span><span class="se">\t</span><span class="s2">999</span><span class="se">\t</span><span class="s2">0.001</span><span class="se">\t</span><span class="s2">0</span><span class="se">\t</span><span class="s2">0.0</span><span class="se">\t</span><span class="s2">0</span><span class="se">\t</span><span class="s2">0.000001</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sample_4&quot;</span><span class="p">)</span>
        <span class="n">expected_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_gender</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00332</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">],</span>
                                  <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Sample shouldn&#39;t be included if chrx is False, but Gender in covars</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Gender&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_gender</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Removing gender in the covar should add a sample</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">covar</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">expected_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Gender&quot;</span><span class="p">)</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c1"># Setting chromosome to X should also include the sample</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Gender&quot;</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_phenotype</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.test_read_samples"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_read_samples">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;read_samples&#39; function.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the sample file</span>
        <span class="n">sample_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ID_1 ID_2 missing father mother sex plink_pheno</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;0 0 0 D D D B</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_1 sample_1 0 0 0 2 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_1 sample_2 0 0 0 1 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_2 sample_3 0 0 0 2 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">sample_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;test.sample&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sample_content</span><span class="p">)</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ID_1&quot;</span><span class="p">]</span>
        <span class="n">expected_index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_3&quot;</span><span class="p">]</span>
        <span class="n">expected_fam</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fam_1&quot;</span><span class="p">,</span> <span class="s2">&quot;fam_1&quot;</span><span class="p">,</span> <span class="s2">&quot;fam_2&quot;</span><span class="p">]</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_samples</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">)</span>

        <span class="c1"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_fam</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">ID_1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="c1"># Having a duplicated samples will trigger an exception</span>
        <span class="n">sample_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ID_1 ID_2 missing father mother sex plink_pheno</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;0 0 0 D D D B</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_1 sample_1 0 0 0 2 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_1 sample_2 0 0 0 1 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;fam_2 sample_2 0 0 0 2 -9</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sample_content</span><span class="p">)</span>

        <span class="c1"># Checking</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_samples</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;Index has duplicate keys&quot;</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestImputedStats.test_read_sites_to_extract"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_read_sites_to_extract">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_sites_to_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;test_read_sites_to_extract&#39; function.&quot;&quot;&quot;</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;marker_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;markers.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># The expected values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;marker_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span>

        <span class="c1"># The observed values</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">read_sites_to_extract</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.test_compute_statistics"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_compute_statistics">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_compute_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;compute_statistics&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.test_process_impute2_site"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_process_impute2_site">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_process_impute2_site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;process_impute2_site&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.test_samples_with_hetero_calls"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_samples_with_hetero_calls">[docs]</a>    <span class="k">def</span> <span class="nf">test_samples_with_hetero_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;samples_with_hetero_calls&#39; function.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_3&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_4&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_5&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_6&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_7&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_8&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sample_9&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;D1&quot;</span><span class="p">,</span> <span class="s2">&quot;D2&quot;</span><span class="p">,</span> <span class="s2">&quot;D3&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># The expected results</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_5&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_7&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_9&quot;</span><span class="p">]</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">samples_with_hetero_calls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;D2&quot;</span><span class="p">)</span>

        <span class="c1"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestImputedStats.test_get_formula"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_get_formula">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;get_formula&#39; function.&quot;&quot;&quot;</span>
        <span class="c1"># Testing with only one phenotype (no covars, no interaction)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span><span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with one covar, no interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + C1&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with more than one covar, no interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + C1 + C2 + C3&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with more than one covar (with gender), no interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + C1 + C2 + C3 + C(Gender)&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with without covar, but with interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;inter&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with one covar and interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + inter + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;inter&quot;</span><span class="p">],</span> <span class="s2">&quot;inter&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with more than one covar and interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;pheno ~ _GenoD + C1 + C2 + C3 + inter + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;inter&quot;</span><span class="p">],</span> <span class="s2">&quot;inter&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with more than one covar and interaction and Gender</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pheno ~ _GenoD + C1 + C2 + C3 + C(Gender) + &quot;</span>
                    <span class="s2">&quot;_GenoD*C(Gender)&quot;</span><span class="p">)</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">],</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c1"># Testing with categorical values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pheno ~ _GenoD + C1 + C2 + C3 + C(Treatment) + &quot;</span>
                    <span class="s2">&quot;C(Population) + C(Gender) + _GenoD*C(Treatment)&quot;</span><span class="p">)</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span>
            <span class="s2">&quot;pheno&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="s2">&quot;Gender&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Gender&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="s2">&quot;Population&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStats.test_check_args"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStats.test_check_args">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_check_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;check_args&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Test not implemented&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImputedStatsCox"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_LIFELINES</span><span class="p">,</span>
                 <span class="s2">&quot;optional requirement (lifelines) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsCox</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestImputedStatsCox.setUp"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span>

        <span class="c1"># The name of the file containing the phenotypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_sim.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># This dataset contains 3 markers + 5 covariables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.tearDown"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c1"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_snp1"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_snp1">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_cox_snp1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function, first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># Formula and columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y + y_d ~ snp1 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="c1"># P value was given by 2*pnorm(z) according to this site</span>
        <span class="c1"># https://stat.ethz.ch/pipermail/r-help/2008-October/178439.html</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9892699611323815256</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0645633075569013448</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.11581171866669093</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.86272820359807223</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">15.32247957186071652</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">5.41131727236088009e-53</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_snp2"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_snp2">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_cox_snp2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function, second SNP.&quot;&quot;&quot;</span>
        <span class="c1"># Formula and columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y + y_d ~ snp2 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.0499084338021939383</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0401904025600694215</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.12868017534409637</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">1.241799798536472599</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.21431043709814412423</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_snp3"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_snp3">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_cox_snp3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function, third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># Formula and columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y + y_d ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">1.114732193640146418</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0631205046371715733</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.991018277865296726</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">1.23844610941499611</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">17.660381520202268035</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">8.46654634146707403e-70</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_invalid"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_cox_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function, third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y + y_d ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_cox</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s2">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_interaction_snp1"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_interaction_snp1">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_cox_interaction_snp1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function with interaction, first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># Formula and columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y + y_d ~ snp1 + C1 + C2 + C3 + age + C(gender) + &quot;</span>
                   <span class="s2">&quot;snp1*C(gender)&quot;</span><span class="p">)</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.08002859476478209</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.12198270334604862</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15905311053030668</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.31911030005987090</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">0.6560651024248222</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.51178223698621716</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1:C(gender)[T.2]&quot;</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_cox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.9892699611323815256</span><span class="p">,</span> <span class="mf">0.0499084338021939383</span><span class="p">,</span>
                             <span class="mf">1.114732193640146418</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0645633075569013448</span><span class="p">,</span> <span class="mf">0.0401904025600694215</span><span class="p">,</span>
                             <span class="mf">0.0631205046371715733</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.11581171866669093</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span><span class="p">,</span>
                             <span class="mf">0.991018277865296726</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.86272820359807223</span><span class="p">,</span> <span class="mf">0.12868017534409637</span><span class="p">,</span>
                             <span class="mf">1.23844610941499611</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">15.32247957186071652</span><span class="p">,</span> <span class="mf">1.241799798536472599</span><span class="p">,</span>
                             <span class="mf">17.660381520202268035</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.41131727236088009e-53</span><span class="p">,</span> <span class="mf">0.21431043709814412423</span><span class="p">,</span>
                             <span class="mf">8.46654634146707403e-70</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox_multiprocess">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_cox_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.9892699611323815256</span><span class="p">,</span> <span class="mf">0.0499084338021939383</span><span class="p">,</span>
                             <span class="mf">1.114732193640146418</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0645633075569013448</span><span class="p">,</span> <span class="mf">0.0401904025600694215</span><span class="p">,</span>
                             <span class="mf">0.0631205046371715733</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.11581171866669093</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span><span class="p">,</span>
                             <span class="mf">0.991018277865296726</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.86272820359807223</span><span class="p">,</span> <span class="mf">0.12868017534409637</span><span class="p">,</span>
                             <span class="mf">1.23844610941499611</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">15.32247957186071652</span><span class="p">,</span> <span class="mf">1.241799798536472599</span><span class="p">,</span>
                             <span class="mf">17.660381520202268035</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.41131727236088009e-53</span><span class="p">,</span> <span class="mf">0.21431043709814412423</span><span class="p">,</span>
                             <span class="mf">8.46654634146707403e-70</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_cox_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.08002859476478209</span><span class="p">,</span> <span class="mf">0.06043867499981825</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.1346941460446854</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12198270334604862</span><span class="p">,</span> <span class="mf">0.08096689170729621</span><span class="p">,</span>
                             <span class="mf">0.12150431017471298</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.15905311053030668</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09825351668663704</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.3728382179535064</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.31911030005987090</span><span class="p">,</span> <span class="mf">0.2191308666862735</span><span class="p">,</span>
                             <span class="mf">0.1034499258641357</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.6560651024248222</span><span class="p">,</span> <span class="mf">0.7464615934413091</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">1.1085544689814419</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.51178223698621716</span><span class="p">,</span> <span class="mf">0.455388623883973054</span><span class="p">,</span>
                             <span class="mf">0.267622429183913102</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImputedStatsLinear"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_STATSMODELS</span><span class="p">,</span>
                 <span class="s2">&quot;optional requirement (statsmodels) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsLinear</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestImputedStatsLinear.setUp"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span>

        <span class="c1"># The name of the dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_sim.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># The name of the dataset with interaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_sim_inter.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># The dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c1"># This dataset contains 3 markers + 5 covariables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_inter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                                      <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.tearDown"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c1"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_snp1"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_snp1">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_linear_snp1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function, first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp1 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="c1"># The data was simulated so that snp1 had a coefficient of 0.1</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.09930262321654575</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00302135517743109</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.09337963040899197</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.10522561602409949</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="mf">32.866914806414108</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.7965174627917724e-217</span>
        <span class="n">expected_r</span> <span class="o">=</span> <span class="mf">0.9872290819785703</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_r</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_snp2"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_snp2">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_linear_snp2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function, second SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp2 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="c1"># The data was simulated so that snp1 had a coefficient of 0</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00279702443754753</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00240385609310785</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.0019154378562692411</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.1635573550209353</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.24465167231462448</span>
        <span class="n">expected_r</span> <span class="o">=</span> <span class="mf">0.984835918173383</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_r</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_snp3"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_snp3">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_linear_snp3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function, third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="c1"># The data was simulated so that snp1 had a coefficient of -0.12</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.11731595824657762</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00327175651867383</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.12372983188610413</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1109020846070511</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="o">-</span><span class="mf">35.857178728608552</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.4882495142044017e-254</span>
        <span class="n">expected_r</span> <span class="o">=</span> <span class="mf">0.9876017832216732</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_r</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_invalid"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_linear_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function, invalid values.&quot;&quot;&quot;</span>
        <span class="c1"># The columns to keep</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s2">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_linear_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp1 + C1 + C2 + C3 + age + C(gender) + snp1*C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="c1"># The data was simulated so that snp1 had a coefficient of 0.1</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.101959570845217173</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00588764130382715949</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.090417578486636035</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.11350156320379831</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="mf">17.3175581839437314</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">1.5527088106478929e-65</span>
        <span class="n">expected_r</span> <span class="o">=</span> <span class="mf">0.9881088609703202</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1:C(gender)[T.2]&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_r</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;adj.r-squared&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09930262321654575</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00279702443754753</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.11731595824657762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00302135517743109</span><span class="p">,</span> <span class="mf">0.00240385609310785</span><span class="p">,</span>
                    <span class="mf">0.00327175651867383</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09337963040899197</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.12372983188610413</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.10522561602409949</span><span class="p">,</span> <span class="mf">0.0019154378562692411</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.1109020846070511</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">32.866914806414108</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1635573550209353</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">35.857178728608552</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.7965174627917724e-217</span><span class="p">,</span> <span class="mf">0.24465167231462448</span><span class="p">,</span>
                    <span class="mf">2.4882495142044017e-254</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The adjusted R-squared</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9872290819785703</span><span class="p">,</span> <span class="mf">0.984835918173383</span><span class="p">,</span> <span class="mf">0.9876017832216732</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span>
                                          <span class="n">observed</span><span class="p">[</span><span class="s2">&quot;adj.r-squared&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear_multiprocess">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_linear_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;adj.r-squared&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09930262321654575</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00279702443754753</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.11731595824657762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00302135517743109</span><span class="p">,</span> <span class="mf">0.00240385609310785</span><span class="p">,</span>
                    <span class="mf">0.00327175651867383</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09337963040899197</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.12372983188610413</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.10522561602409949</span><span class="p">,</span> <span class="mf">0.0019154378562692411</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.1109020846070511</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">32.866914806414108</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1635573550209353</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">35.857178728608552</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.7965174627917724e-217</span><span class="p">,</span> <span class="mf">0.24465167231462448</span><span class="p">,</span>
                    <span class="mf">2.4882495142044017e-254</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The adjusted R-squared</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9872290819785703</span><span class="p">,</span> <span class="mf">0.984835918173383</span><span class="p">,</span> <span class="mf">0.9876017832216732</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span>
                                          <span class="n">observed</span><span class="p">[</span><span class="s2">&quot;adj.r-squared&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_linear_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;adj.r-squared&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1019595708452171734</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.010917110807672320352</span><span class="p">,</span>
                    <span class="mf">0.02657634353683377762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005887641303827159493</span><span class="p">,</span> <span class="mf">0.006578361146066042525</span><span class="p">,</span>
                    <span class="mf">0.009435607764482155033</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0904175784866360355</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0238131739612693419</span><span class="p">,</span>
                    <span class="mf">0.00807900188569928013</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.113501563203798311</span><span class="p">,</span> <span class="mf">0.00197895234592469944</span><span class="p">,</span>
                    <span class="mf">0.0450736851879682751</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">17.31755818394373136</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.65954871817898208519</span><span class="p">,</span>
                    <span class="mf">2.816601134785761129</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.55270881064789290e-65</span><span class="p">,</span> <span class="mf">9.70597574168038796e-02</span><span class="p">,</span>
                    <span class="mf">4.87000487450673421e-03</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The adjusted R-squared</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9881088609703202</span><span class="p">,</span> <span class="mf">0.9721547595493417</span><span class="p">,</span> <span class="mf">0.9747583839320677</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span>
                                          <span class="n">observed</span><span class="p">[</span><span class="s2">&quot;adj.r-squared&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_r</span><span class="p">,</span> <span class="n">observed_r</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImputedStatsLogistic"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_STATSMODELS</span><span class="p">,</span>
                 <span class="s2">&quot;optional requirement (statsmodels) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsLogistic</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestImputedStatsLogistic.setUp"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span>

        <span class="c1"># The name of the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_sim.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># The name of the data with interaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_sim_inter.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># This dataset contains 3 markers + 5 covariables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c1"># This dataset contains 3 markers + 5 covariables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_inter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                                      <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.tearDown"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c1"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_snp1"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_snp1">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_logistic_snp1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function, first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y_d ~ snp1 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.514309712761157334</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.1148545370213162609</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.741288870474147710</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.290848443930784406</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.477922475676383129</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">7.53729612963228856e-06</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_snp2"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_snp2">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_logistic_snp2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function, second SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y_d ~ snp2 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0409615621727592721</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0898086129043482589</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.217201661656268197</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.135039323830941221</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.456098372395372320</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">6.48319240531225471e-01</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_snp3"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_snp3">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_logistic_snp3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function, third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y_d ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.6806154974808061864</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.1216909125194588076</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.442504664626330035</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.919770526738653338</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">5.5929854036715633825</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.23198061422542684e-08</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_invalid"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_logistic_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function, invalid values.&quot;&quot;&quot;</span>
        <span class="c1"># The formula and columns</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y_d ~ snp3 + C1 + C2 + C3 + age + C(gender)&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s2">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp3&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_logistic_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y_d ~ snp1 + C1 + C2 + C3 + age + C(gender) + &quot;</span>
                   <span class="s2">&quot;snp1*C(gender)&quot;</span><span class="p">)</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span> <span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4998229445983128905</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.2425924038476814093</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9779101205637230620</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0263169240328645603</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0603404586078508665</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">3.93660046768015970e-02</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">],</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;snp1:C(gender)[T.2]&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_logistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for logistic regression.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.514309712761163662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0409615621727604101</span><span class="p">,</span>
                    <span class="mf">0.6806154974808032998</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1148545370213169270</span><span class="p">,</span> <span class="mf">0.0898086129043478426</span><span class="p">,</span>
                    <span class="mf">0.1216909125194589325</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.741288870474143935</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.217201661656271972</span><span class="p">,</span>
                    <span class="mf">0.442504664626339528</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.290848443930769640</span><span class="p">,</span> <span class="mf">0.135039323830934560</span><span class="p">,</span>
                    <span class="mf">0.919770526738648897</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.477922475676412439</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456098372395387086</span><span class="p">,</span>
                    <span class="mf">5.592985403671533184</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.53729612963125518e-06</span><span class="p">,</span> <span class="mf">6.48319240531214813e-01</span><span class="p">,</span>
                    <span class="mf">2.23198061422581463e-08</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic_multiprocess">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_logistic_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline, logistic regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.514309712761163662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0409615621727604101</span><span class="p">,</span>
                    <span class="mf">0.6806154974808032998</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1148545370213169270</span><span class="p">,</span> <span class="mf">0.0898086129043478426</span><span class="p">,</span>
                    <span class="mf">0.1216909125194589325</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.741288870474143935</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.217201661656271972</span><span class="p">,</span>
                    <span class="mf">0.442504664626339528</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.290848443930769640</span><span class="p">,</span> <span class="mf">0.135039323830934560</span><span class="p">,</span>
                    <span class="mf">0.919770526738648897</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.477922475676412439</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456098372395387086</span><span class="p">,</span>
                    <span class="mf">5.592985403671533184</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.53729612963125518e-06</span><span class="p">,</span> <span class="mf">6.48319240531214813e-01</span><span class="p">,</span>
                    <span class="mf">2.23198061422581463e-08</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_logistic_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for logistic regression with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_inter_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4998229445983128905</span><span class="p">,</span> <span class="mf">0.479196060192496665</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.081500925621293116</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2425924038476814093</span><span class="p">,</span> <span class="mf">0.1732540442374335965</span><span class="p">,</span>
                    <span class="mf">0.236081283702105793</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.9779101205637230620</span><span class="p">,</span> <span class="mf">0.140220059149237547</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.544942749175234886</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.0263169240328645603</span><span class="p">,</span> <span class="mf">0.819710161131259829</span><span class="p">,</span>
                    <span class="mf">0.380931176186822595</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0603404586078508665</span><span class="p">,</span> <span class="mf">2.765857860932753098</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.345224002272595865</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.93660046768015970e-02</span><span class="p">,</span> <span class="mf">5.67732747277691768e-03</span><span class="p">,</span>
                    <span class="mf">7.29925975515044678e-01</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImputedStatsMixedLM"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_STATSMODELS</span><span class="p">,</span>
                 <span class="s2">&quot;optional requirement (statsmodels) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsMixedLM</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestImputedStatsMixedLM.setUpClass"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the data and compute random effects.&quot;&quot;&quot;</span>
        <span class="c1"># Reading the data</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_mixedlm.txt.bz2&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># This dataset contains 3 markers + 6 covariables (including visit)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">gender</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;SampleID&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Computing the random effect for REML</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">random_effects</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">_extract_mixedlm_random_effect</span><span class="p">(</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span>
                <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;y ~ C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">reml</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Computing the random effect for ML</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">random_effects_ml</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">_extract_mixedlm_random_effect</span><span class="p">(</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span>
                <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;y ~ C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">reml</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.setUp"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.tearDown"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c1"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp1"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp1">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_mixedlm&#39; function for the first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp1&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.12265168980977093</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.026125844399462177</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.07144597572112760</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.1738574038984143</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">4.6946497856465763</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.670638639346024e-06</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp2"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp2">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_mixedlm&#39; function for the second SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the second marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the second SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp2&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.6780830649776308</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;TS-MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp3"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp3">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_mixedlm&#39; function for the third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the third (and last) marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the second SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp3&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15449981039313726</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.028692891145471563</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.21073684365058973</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.09826277713568479</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.3846023954097459</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">7.260496248662207e-08</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_invalid_column"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_invalid_column">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_invalid_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests when asking an invalid column.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp1&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">,</span>
                <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">):</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s2">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
                <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span><span class="p">,</span>
                <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp1_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp1_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp1_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests mixedlm using ML on first SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp1&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.12265168980975952</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.026109971717277716</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.07147708560653579</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.1738262940129832</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">4.6975037406339810</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.633603631840842e-06</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects_ml</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp2_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp2_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp2_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests mixedlm using ML on second SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the second marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ snp2 + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp2&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.6780830649776319</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;TS-MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects_ml</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_snp3_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_snp3_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_snp3_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests mixedlm using ML on third SNP.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the third (and last) marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit)&quot;</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp1&quot;</span><span class="p">,</span> <span class="s2">&quot;snp2&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp3&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15449981039314364</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.02867546407987996</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.21070268722968036</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.09829693355660693</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.3878748034473105</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">7.129568602159964e-08</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_effects_ml</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_mixedlm&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit) + &quot;</span>
                   <span class="s2">&quot;_GenoD*C(visit)&quot;</span><span class="p">)</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp1&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.05156182795999706</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.06049308027425798</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.06700243069143892</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.1701260866114330</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">0.8523591082852910</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">3.940148087160935e-01</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD:C(visit)[T.3]&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_fit_mixedlm_interaction_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_fit_mixedlm_interaction_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_fit_mixedlm_interaction_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_mixedlm&#39; function with interaction (using ML).&quot;&quot;&quot;</span>
        <span class="c1"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;y ~ _GenoD + C1 + C2 + C3 + age + C(gender) + C(visit) + &quot;</span>
                   <span class="s2">&quot;_GenoD*C(visit)&quot;</span><span class="p">)</span>

        <span class="c1"># Removing unwanted columns and renaming the first SNP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;snp2&quot;</span><span class="p">,</span> <span class="s2">&quot;snp3&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;snp1&quot;</span><span class="p">:</span> <span class="s2">&quot;_GenoD&quot;</span><span class="p">})</span>

        <span class="c1"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.05156182795997794</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.060482583773306557</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.06698185792762956</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.1701055138475855</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">0.8525070316644490</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">3.939327379391016e-01</span>
        <span class="n">expected_type</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>

        <span class="c1"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">fit_mixedlm</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s2">&quot;_GenoD:C(visit)[T.3]&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_effects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mixedlm_p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_type</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c1"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">observed_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for mixed effect model.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12265168980977093</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.15449981039313726</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.026125844399462177</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="mf">0.028692891145471563</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.07144597572112760</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.21073684365058973</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1738574038984143</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09826277713568479</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.6946497856465763</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3846023954097459</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.670638639346024e-06</span><span class="p">,</span> <span class="mf">0.6780830649776308</span><span class="p">,</span>
                             <span class="mf">7.260496248662207e-08</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The analysis type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;TS-MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;MixedLM&quot;</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for mixed effect model (using ML).&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12265168980975952</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.15449981039314364</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.026109971717277716</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="mf">0.02867546407987996</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.07147708560653579</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.21070268722968036</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1738262940129832</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09829693355660693</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.6975037406339810</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3878748034473105</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.633603631840842e-06</span><span class="p">,</span> <span class="mf">0.6780830649776319</span><span class="p">,</span>
                             <span class="mf">7.129568602159964e-08</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;TS-MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;MixedLM&quot;</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm_multiprocess">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline, mixed linear model with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12265168980977093</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.15449981039313726</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.026125844399462177</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="mf">0.028692891145471563</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.07144597572112760</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.21073684365058973</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1738574038984143</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09826277713568479</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.6946497856465763</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3846023954097459</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.670638639346024e-06</span><span class="p">,</span> <span class="mf">0.6780830649776308</span><span class="p">,</span>
                             <span class="mf">7.260496248662207e-08</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;TS-MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;MixedLM&quot;</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm_multiprocess_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm_multiprocess_use_ml">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm_multiprocess_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline, mixed linear with &gt;1 processes (ML).&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12265168980975952</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.15449981039314364</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.026109971717277716</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="mf">0.02867546407987996</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.07147708560653579</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.21070268722968036</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1738262940129832</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09829693355660693</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.6975037406339810</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3878748034473105</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.633603631840842e-06</span><span class="p">,</span> <span class="mf">0.6780830649776319</span><span class="p">,</span>
                             <span class="mf">7.129568602159964e-08</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;TS-MixedLM&quot;</span><span class="p">,</span> <span class="s2">&quot;MixedLM&quot;</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm_interaction"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for mixed linear model with interaction.&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s2">&quot;visit&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05156182795999706</span><span class="p">,</span> <span class="mf">0.014028504378343923</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.101164199650016218</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.06049308027425798</span><span class="p">,</span> <span class="mf">0.044179901027834402</span><span class="p">,</span>
                             <span class="mf">0.066498803156555431</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.06700243069143892</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07256251047675560</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.23149945885188331</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1701260866114330</span><span class="p">,</span> <span class="mf">0.10061951923344345</span><span class="p">,</span>
                             <span class="mf">0.02917105955185087</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8523591082852910</span><span class="p">,</span> <span class="mf">0.3175313672501355</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">1.5212935398528820</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.940148087160935e-01</span><span class="p">,</span> <span class="mf">7.508404423440460e-01</span><span class="p">,</span>
                             <span class="mf">1.281861906944759e-01</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The analysis type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsMixedLM.test_full_fit_mixedlm_interaction_use_ml"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsMixedLM.test_full_fit_mixedlm_interaction_use_ml">[docs]</a>    <span class="k">def</span> <span class="nf">test_full_fit_mixedlm_interaction_use_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for mixed linear model (interaction, ML).&quot;&quot;&quot;</span>
        <span class="c1"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s2">&quot;mixedlm&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;SampleID&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s2">&quot;visit&quot;</span><span class="p">,</span>
            <span class="n">use_ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">))</span>

        <span class="c1"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.mixedlm.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Checking the shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;snp&quot;</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="s2">&quot;maf&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c1"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c1"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s2">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c1"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c1"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c1"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4605</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11528</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5764</span><span class="p">,</span> <span class="mi">5764</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c1"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05156182795997794</span><span class="p">,</span> <span class="mf">0.014028504378316063</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.101164199649998621</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.060482583773306557</span><span class="p">,</span> <span class="mf">0.044172234988136105</span><span class="p">,</span>
                             <span class="mf">0.06648726468681930</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.06698185792762956</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07254748531507074</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">0.23147684386674616</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1701055138475855</span><span class="p">,</span> <span class="mf">0.10060449407170288</span><span class="p">,</span>
                             <span class="mf">0.02914844456674892</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8525070316644490</span><span class="p">,</span> <span class="mf">0.3175864744467622</span><span class="p">,</span>
                             <span class="o">-</span><span class="mf">1.5215575513073230</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.939327379391016e-01</span><span class="p">,</span> <span class="mf">7.507986352043505e-01</span><span class="p">,</span>
                             <span class="mf">1.281199805761517e-01</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The analysis type</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;MixedLM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImputedStatsSkat"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">imputed_stats</span><span class="o">.</span><span class="n">HAS_SKAT</span><span class="p">,</span> <span class="s2">&quot;SKAT is not installed&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsSkat</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestImputedStatsSkat.setUpClass"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;genipe_test_&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">setup_skat_files</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.tearDownClass"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.tearDownClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Cleaning the temporary directory</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.test_continuous"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.test_continuous">[docs]</a>    <span class="k">def</span> <span class="nf">test_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;skat_test_continuous&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s2">&quot;outcome_continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">,</span> <span class="s2">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.002877041</span><span class="p">,</span> <span class="mf">0.09319144</span><span class="p">,</span> <span class="mf">0.002877041</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">298041.5</span><span class="p">,</span> <span class="mf">24870.14</span><span class="p">,</span> <span class="mf">298041.5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.test_discrete"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.test_discrete">[docs]</a>    <span class="k">def</span> <span class="nf">test_discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;skat_test_discrete&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s2">&quot;outcome_discrete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s2">&quot;discrete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">,</span> <span class="s2">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1401991</span><span class="p">,</span> <span class="mf">0.5868036</span><span class="p">,</span> <span class="mf">0.1401991</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">34934.79</span><span class="p">,</span> <span class="mf">2776.797</span><span class="p">,</span> <span class="mf">34934.79</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.test_continuous_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.test_continuous_multiprocess">[docs]</a>    <span class="k">def</span> <span class="nf">test_continuous_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;skat_test_continuous_mp&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s2">&quot;outcome_continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">,</span> <span class="s2">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.002877041</span><span class="p">,</span> <span class="mf">0.09319144</span><span class="p">,</span> <span class="mf">0.002877041</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">298041.5</span><span class="p">,</span> <span class="mf">24870.14</span><span class="p">,</span> <span class="mf">298041.5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.test_discrete_multiprocess"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.test_discrete_multiprocess">[docs]</a>    <span class="k">def</span> <span class="nf">test_discrete_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;skat_test_discrete_mp&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s2">&quot;outcome_discrete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s2">&quot;discrete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Executing the tool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imputed_stats</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c1"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s2">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">,</span> <span class="s2">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c1"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1401991</span><span class="p">,</span> <span class="mf">0.5868036</span><span class="p">,</span> <span class="mf">0.1401991</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">34934.79</span><span class="p">,</span> <span class="mf">2776.797</span><span class="p">,</span> <span class="mf">34934.79</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestImputedStatsSkat.setup_skat_files"><a class="viewcode-back" href="../../../module_content/genipe.tests.html#genipe.tests.test_imputed_stats.TestImputedStatsSkat.setup_skat_files">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_skat_files</span><span class="p">(</span><span class="n">out_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the SKAT example files into the format expected by genipe.&quot;&quot;&quot;</span>
        <span class="c1"># Read the SKAT example files.</span>
        <span class="n">skat_x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c1"># Covariates</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;skat_x_matrix.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;covar_discrete&quot;</span><span class="p">,</span> <span class="s2">&quot;covar_continuous&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">skat_z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c1"># Genotypes</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="vm">__name__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;skat_z_matrix.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">skat_y_continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c1"># Outcome, continuous</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="vm">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;skat_y_continuous_vector.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;outcome_continuous&quot;</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">skat_y_discrete</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c1"># Outcome, discrete</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="vm">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;skat_y_discrete_vector.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;outcome_discrete&quot;</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Write the Impute2 file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;impute2.txt&quot;</span><span class="p">)</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                <span class="n">chrom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">90000000</span><span class="p">)</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;ATGC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">variant_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{chrom}</span><span class="s2">:</span><span class="si">{pos}</span><span class="s2">:</span><span class="si">{a2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">chrom</span><span class="o">=</span><span class="n">chrom</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="n">a2</span>
                <span class="p">)</span>
                <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant_name</span><span class="p">)</span>

                <span class="n">row</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{chrom}</span><span class="s2"> </span><span class="si">{name}</span><span class="s2"> </span><span class="si">{pos}</span><span class="s2"> </span><span class="si">{a1}</span><span class="s2"> </span><span class="si">{a2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">chrom</span><span class="o">=</span><span class="n">chrom</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">variant_name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">dosage_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">dosage</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span>
                        <span class="n">skat_z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="n">dosage_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>

                <span class="c1"># Make sure all the probabilities are in the [0, 1] interval.</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proba</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dosage_list</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">if</span> <span class="n">proba</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dosage_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">proba</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dosage_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="o">*</span><span class="n">dosage_list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="c1"># Create the snp set file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;snp_sets.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;variant&quot;</span><span class="p">,</span> <span class="s2">&quot;snp_set&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
            <span class="c1"># The first SNP set</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s2">&quot;set1&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

            <span class="c1"># The second SNP set (which contains only the first 10 markers, and</span>
            <span class="c1"># the last 10)</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">variants</span><span class="p">[</span><span class="mi">30</span><span class="p">]]</span> <span class="o">+</span> <span class="n">variants</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s2">&quot;set2&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

            <span class="c1"># The last SNP set (which is the same as the first one)</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s2">&quot;set3&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="c1"># Create a list of samples.</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Get the filename for the phenotype file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;phenotypes.txt&quot;</span><span class="p">)</span>

        <span class="c1"># Before we can write it, we need to add a samples column.</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span>
        <span class="n">skat_x</span> <span class="o">=</span> <span class="n">skat_x</span><span class="p">[[</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;covar_discrete&quot;</span><span class="p">,</span> <span class="s2">&quot;covar_continuous&quot;</span><span class="p">]]</span>

        <span class="c1"># We also add the outcomes to this (genipe uses a single file for both</span>
        <span class="c1"># the outcome and the covariates).</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s2">&quot;outcome_continuous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skat_y_continuous</span><span class="o">.</span><span class="n">values</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s2">&quot;outcome_discrete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skat_y_discrete</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Write the phenotype file.</span>
        <span class="n">skat_x</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Get the filename for the samples file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;samples.txt&quot;</span><span class="p">)</span>

        <span class="c1"># Now we write the samples file by imitating the Impute2 format.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ID_1 ID_2 missing father mother sex phenotype&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;0 0 0 D D D B&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
                      <span class="s2">&quot;-9&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="c1"># Finally, prepare the arguments for the script.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;skat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--impute2&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;impute2.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;--sample&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;samples.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;--pheno&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;phenotypes.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;--snp-set&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;snp_sets.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;--covar&quot;</span><span class="p">,</span> <span class="s2">&quot;covar_discrete,covar_continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--sample-column&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--gender-column&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">args</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">genipe 1.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../genipe.html" >genipe</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">genipe.tests.test_imputed_stats</a></li> 
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Beaulieu-Saucier Pharmacogenomics Centre.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-81009922-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>